/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {

    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    withName: 'MULTIQC' {
        container = {
            workflow.containerEngine == 'singularity' && !task.ext.singularity_pull_docker_container ?
                'https://depot.galaxyproject.org/singularity/multiqc:1.29--pyhdfd78af_0' :
            workflow.containerEngine == 'docker' || task.ext.singularity_pull_docker_container ?
                'biocontainers/multiqc:1.32--pyhdfd78af_0' :
            ''
        }
        ext.args   = { params.multiqc_title ? "--title \"$params.multiqc_title\"" : '' }
        publishDir = [
            path: { "${params.outdir}/multiqc" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: "IQTREE" {
        ext.args = "-m GTR+I+G"
    }

    // HyPhy branch selection control via params.test_branches
    // Accepted values:
    //   - 'internal' -> adds --branches 'Internal'
    //   - 'all'      -> adds --branches 'All'
    //   - not set    -> no flag (HyPhy default applies)
    withName: "HYPHY_FEL" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            def branch = b == 'internal' ? "--branches 'Internal'" :
                         b == 'all' ? "--branches 'All'" :
                         ''
            def raw = params.code?.toString()?.trim()
            def code = ''
            if (raw) {
                def isNum = raw ==~ /^\d+$/
                def hy = isNum ? raw : ((raw.equalsIgnoreCase('standard') || raw.equalsIgnoreCase('universal')) ? 'Universal' : raw)
                code = "--code '${hy}'"
            }
            [branch, code].findAll{ it }.join(' ')
        }
    }
    withName: "HYPHY_MEME" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            def branch = b == 'internal' ? "--branches 'Internal'" :
                         b == 'all' ? "--branches 'All'" :
                         ''
            def raw = params.code?.toString()?.trim()
            def code = ''
            if (raw) {
                def isNum = raw ==~ /^\d+$/
                def hy = isNum ? raw : (raw.equalsIgnoreCase('standard') ? 'Universal' : raw)
                code = "--code '${hy}'"
            }
            [branch, code].findAll{ it }.join(' ')
        }
    }
    withName: "HYPHY_PRIME" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            def branch = b == 'internal' ? "--branches 'Internal'" :
                         b == 'all' ? "--branches 'All'" :
                         ''
            def raw = params.code?.toString()?.trim()
            def code = ''
            if (raw) {
                def isNum = raw ==~ /^\d+$/
                def hy = isNum ? raw : (raw.equalsIgnoreCase('standard') ? 'Universal' : raw)
                code = "--code '${hy}'"
            }
            [branch, code].findAll{ it }.join(' ')
        }
    }
    withName: "HYPHY_BUSTED" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            def branch = b == 'internal' ? "--branches 'Internal'" :
                         b == 'all' ? "--branches 'All'" :
                         ''
            def raw = params.code?.toString()?.trim()
            def code = ''
            if (raw) {
                def isNum = raw ==~ /^\d+$/
                def hy = isNum ? raw : (raw.equalsIgnoreCase('standard') ? 'Universal' : raw)
                code = "--code '${hy}'"
            }
            [branch, code].findAll{ it }.join(' ')
        }
    }

    // Pass genetic code to HyPhy contrast-fel and relax
    withName: "HYPHY_CONTRASTFEL" {
        ext.args = {
            def raw = params.code?.toString()?.trim()
            if (raw) {
                def isNum = raw ==~ /^\d+$/
                def hy = isNum ? raw : ((raw.equalsIgnoreCase('standard') || raw.equalsIgnoreCase('universal')) ? 'Universal' : raw)
                return "--code '${hy}'"
            }
            return ''
        }
    }
    withName: "HYPHY_RELAX" {
        ext.args = {
            def raw = params.code?.toString()?.trim()
            if (raw) {
                def isNum = raw ==~ /^\d+$/
                def hy = isNum ? raw : (raw.equalsIgnoreCase('standard') ? 'Universal' : raw)
                return "--code '${hy}'"
            }
            return ''
        }
    }
    withName: "HYPHYMPI_FEL" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            def branch = b == 'internal' ? "--branches 'Internal'" :
                         b == 'all' ? "--branches 'All'" :
                         ''
            def raw = params.code?.toString()?.trim()
            def code = ''
            if (raw) {
                def isNum = raw ==~ /^\d+$/
                def hy = isNum ? raw : (raw.equalsIgnoreCase('standard') ? 'Universal' : raw)
                code = "--code '${hy}'"
            }
            [branch, code].findAll{ it }.join(' ')
        }
    }
    withName: "HYPHYMPI_MEME" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            def branch = b == 'internal' ? "--branches 'Internal'" :
                         b == 'all' ? "--branches 'All'" :
                         ''
            def raw = params.code?.toString()?.trim()
            def code = ''
            if (raw) {
                def isNum = raw ==~ /^\d+$/
                def hy = isNum ? raw : (raw.equalsIgnoreCase('standard') ? 'Universal' : raw)
                code = "--code '${hy}'"
            }
            [branch, code].findAll{ it }.join(' ')
        }
    }
    withName: "HYPHYMPI_PRIME" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            def branch = b == 'internal' ? "--branches 'Internal'" :
                         b == 'all' ? "--branches 'All'" :
                         ''
            def raw = params.code?.toString()?.trim()
            def code = ''
            if (raw) {
                def isNum = raw ==~ /^\d+$/
                def hy = isNum ? raw : (raw.equalsIgnoreCase('standard') ? 'Universal' : raw)
                code = "--code '${hy}'"
            }
            [branch, code].findAll{ it }.join(' ')
        }
    }

    // MPI contrast-fel
    withName: "HYPHYMPI_CONTRASTFEL" {
        ext.args = {
            def raw = params.code?.toString()?.trim()
            if (raw) {
                def isNum = raw ==~ /^\d+$/
                def hy = isNum ? raw : (raw.equalsIgnoreCase('standard') ? 'Universal' : raw)
                return "--code '${hy}'"
            }
            return ''
        }
    }

    // HyPhy CLN: set code name for the positional argument
    withName: "HYPHY_CLN" {
        ext.hyphy_code = {
            def raw = params.code?.toString()?.trim()
            if (!raw) return 'Universal'
            def isNum = raw ==~ /^\d+$/
            return isNum ? raw : ((raw.equalsIgnoreCase('standard') || raw.equalsIgnoreCase('universal')) ? 'Universal' : raw)
        }
    }

    // Remove-terminal-stop-codon: pass translation table to Python
    withName: "REMOVETERMINALSTOPCODON" {
        ext.args = {
            def raw = params.code?.toString()?.trim()
            if (!raw) return ''
            return "--table '${raw}'"
        }
    }

}
