/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {

    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    withName: 'MULTIQC' {
        container = {
            workflow.containerEngine == 'singularity' && !task.ext.singularity_pull_docker_container ?
                'https://depot.galaxyproject.org/singularity/multiqc:1.29--pyhdfd78af_0' :
            workflow.containerEngine == 'docker' || task.ext.singularity_pull_docker_container ?
                'biocontainers/multiqc:1.32--pyhdfd78af_0' :
            ''
        }
        ext.args   = { params.multiqc_title ? "--title \"$params.multiqc_title\"" : '' }
        publishDir = [
            path: { "${params.outdir}/multiqc" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: "IQTREE" {
        ext.args = "-m GTR+I+G"
    }

    // HyPhy branch selection control via params.test_branches
    // Accepted values:
    //   - 'internal' -> adds --branches 'Internal'
    //   - 'all'      -> adds --branches 'All'
    //   - not set    -> no flag (HyPhy default applies)
    withName: "HYPHY_FEL" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            b == 'internal' ? "--branches 'Internal'" :
            b == 'all' ? "--branches 'All'" :
            ''
        }
    }
    withName: "HYPHY_MEME" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            b == 'internal' ? "--branches 'Internal'" :
            b == 'all' ? "--branches 'All'" :
            ''
        }
    }
    withName: "HYPHY_PRIME" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            b == 'internal' ? "--branches 'Internal'" :
            b == 'all' ? "--branches 'All'" :
            ''
        }
    }
    withName: "HYPHY_BUSTED" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            b == 'internal' ? "--branches 'Internal'" :
            b == 'all' ? "--branches 'All'" :
            ''
        }
    }
    withName: "HYPHYMPI_FEL" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            b == 'internal' ? "--branches 'Internal'" :
            b == 'all' ? "--branches 'All'" :
            ''
        }
    }
    withName: "HYPHYMPI_MEME" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            b == 'internal' ? "--branches 'Internal'" :
            b == 'all' ? "--branches 'All'" :
            ''
        }
    }
    withName: "HYPHYMPI_PRIME" {
        ext.args = {
            def b = params.test_branches?.toString()?.toLowerCase()
            b == 'internal' ? "--branches 'Internal'" :
            b == 'all' ? "--branches 'All'" :
            ''
        }
    }

}
