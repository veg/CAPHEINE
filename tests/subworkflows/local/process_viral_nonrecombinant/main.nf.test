nextflow_workflow {

    name "Test Subworkflow PROCESS_VIRAL_NONRECOMBINANT"
    script "subworkflows/local/process_viral_nonrecombinant/main.nf"
    workflow "PROCESS_VIRAL_NONRECOMBINANT"

    tag "subworkflows"
    tag "subworkflows/process_viral_nonrecombinant"
    tag "removeambigseqs"
    tag "cawlign"
    tag "hyphy_cln"
    tag "iqtree"
    tag "hyphy_labeltree_list"

    test("denv1 - fasta - no tree labeling") {
        when {
            params {
                foreground_list = null
                foreground_regexp = null
            }
            workflow {
                """
                input[0] = file(projectDir + '/tests/test_data/pretend-raw-seqs.fasta', checkIfExists: true)
                input[1] = file(projectDir + '/tests/test_data/pretend_DENV1_ref.fasta', checkIfExists: true)
                input[2] = []
                input[3] = []
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert path(workflow.out.deduplicated[0][1]).exists() },
                { assert path(workflow.out.deduplicated[0][1]).toString().endsWith('-nodups.fasta') },
                { assert path(workflow.out.tree[0][1]).exists() },
                { assert path(workflow.out.tree[0][1]).toString().endsWith('.treefile') },
                // no labeled tree should be generated
                { assert !path(workflow.out.tree[0][1]).toString().endsWith('-labeled.treefile') },
                { assert workflow.out.versions.size() == 8 },
                // hacky check, but this test should also generate a warning that no internal branches could be labeled
            )
        }
    }

    test("denv1 - fasta - nonmatching foreground regexp") {
        when {
            params {
                foreground_list = null
                foreground_regexp = ['dontmatch']
            }

            workflow {
                """
                input[0] = file(projectDir + '/tests/test_data/pretend-raw-seqs.fasta', checkIfExists: true)
                input[1] = file(projectDir + '/tests/test_data/pretend_DENV1_ref.fasta', checkIfExists: true)
                input[2] = []
                input[3] = ['dontmatch']
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert path(workflow.out.deduplicated[0][1]).exists() },
                { assert path(workflow.out.deduplicated[0][1]).toString().endsWith('-nodups.fasta') },
                { assert path(workflow.out.tree[0][1]).exists() },
                { assert path(workflow.out.tree[0][1]).toString().endsWith('-labeled.treefile') },
                { assert workflow.out.versions.size() == 10 },
                // hacky check, but this test should also generate a warning that no internal branches could be labeled
            )
        }
    }

    test("denv1 - fasta - foreground list") {
        when {
            params {
                foreground_list = '/Users/hverdonk/nf-core-capheine/tests/test_data/pretend-foreground-seqs.txt'
                foreground_regexp = null
            }

            workflow {
                """
                input[0] = file(projectDir + '/tests/test_data/pretend-raw-seqs.fasta', checkIfExists: true)
                input[1] = file(projectDir + '/tests/test_data/pretend_DENV1_ref.fasta', checkIfExists: true)
                input[2] = file(projectDir + '/tests/test_data/pretend-foreground-seqs.txt', checkIfExists: true)
                input[3] = []
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert path(workflow.out.deduplicated[0][1]).exists() },
                { assert path(workflow.out.deduplicated[0][1]).toString().endsWith('-nodups.fasta') },
                { assert path(workflow.out.tree[0][1]).exists() },
                { assert path(workflow.out.tree[0][1]).toString().endsWith('.treefile') },
                // check if tree is labeled
                { assert path(workflow.out.tree[0][1]).toString().endsWith('-labeled.treefile') },
                { assert workflow.out.versions.size() == 10 },
            )
        }
    }

    test("denv1 - fasta - foreground regexp") {
        when {
            params {
                foreground_list = null
                foreground_regexp = ['*_2023_09_*']
            }
            workflow {
                """
                input[0] = file(projectDir + '/tests/test_data/pretend-raw-seqs.fasta', checkIfExists: true)
                input[1] = file(projectDir + '/tests/test_data/pretend_DENV1_ref.fasta', checkIfExists: true)
                input[2] = []
                input[3] = ['*_2023_09_*']
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert path(workflow.out.deduplicated[0][1]).exists() },
                { assert path(workflow.out.deduplicated[0][1]).toString().endsWith('-nodups.fasta') },
                { assert path(workflow.out.tree[0][1]).exists() },
                { assert path(workflow.out.tree[0][1]).toString().endsWith('.treefile') },
                // check if tree is labeled
                { assert path(workflow.out.tree[0][1]).toString().endsWith('-labeled.treefile') },
                { assert workflow.out.versions.size() == 10 },
                //{ assert path(workflow.out.versions[2]).text.contains('iqtree:') },
                //{ assert path(workflow.out.versions[0]).text.contains('cawlign:') },
            )
        }
    }
}
