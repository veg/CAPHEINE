nextflow_process {

    name "Test Process SEQKIT_SPLIT"
    script "modules/local/seqkit/split/main.nf"
    process "SEQKIT_SPLIT"

    tag "modules"
    tag "modules_"
    tag "seqkit"
    tag "seqkit/split"

    test("P_aeruginosa_cds_short.fasta - 10 CDS") {
        // TODO nf-core: If you are created a test for a chained module
        // (the module requires running more than one process to generate the required output)
        // add the 'setup' method here.
        // You can find more information about how to use a 'setup' method in the docs (https://nf-co.re/docs/contributing/modules#steps-for-creating-nf-test-for-chained-modules).

        when {
            process {
                """
                input = [ file("${projectDir}/tests/test_data/P_aeruginosa_cds_short.fasta", checkIfExists: true) ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() },
                {
                    // Assert that 10 output files are generated
                    def outputFiles = process.out.gene_fastas.flatten().collect { it.toString() }
                    assert outputFiles.size() == 10

                    // Get all headers from the original file
                    def originalHeaders = []
                    def inputFile = new File("${projectDir}/tests/test_data/P_aeruginosa_cds_short.fasta")
                    inputFile.eachLine { line ->
                        if (line.startsWith('>')) {
                            originalHeaders.add(line)
                        }
                    }

                    // Assert that each output file contains exactly one header from the original file
                    outputFiles.each { outputFile ->
                        def foundHeaders = []
                        new File(outputFile).eachLine { line ->
                            if (line.startsWith('>')) {
                                foundHeaders.add(line)
                            }
                        }
                        assert foundHeaders.size() == 1
                        assert originalHeaders.contains(foundHeaders[0])
                    }
                }
            )
        }

    }

    // TODO nf-core: Change the test name preferably indicating the test-data and file-format used but keep the " - stub" suffix.
    test("P_aeruginosa_cds_short.fasta - 10 CDS - stub") {

        options "-stub"

        when {
            process {
                """
                input = [ file("${projectDir}/tests/test_data/P_aeruginosa_cds_short.fasta", checkIfExists: true) ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() },
                // {
                //     // Assert that 3 output files are generated
                //     def outputFiles = process.out.gene_fastas.collect { it.toString() }
                //     assert outputFiles.size() == 3
                // }
            )
        }

    }

}
