nextflow_process {

    name "Test Process HYPHY_LABELTREE_LIST"
    script "modules/local/hyphy/labeltree/main.nf"
    process "HYPHY_LABELTREE_LIST"

    test("labeltree - treefile - list") {

        // TODO nf-core: If you are created a test for a chained module
        // (the module requires running more than one process to generate the required output)
        // add the 'setup' method here.
        // You can find more information about how to use a 'setup' method in the docs (https://nf-co.re/docs/contributing/modules#steps-for-creating-nf-test-for-chained-modules).

        when {
            process {
                """
                input[0] = [
                    [ id:'FBgn0000055_NT_033779.5_10_species_12_seqs'], 
                    file(projectDir + '/tests/test_data/FBgn0000055_NT_033779.5_10_species_12_seqs-unlabeled.fasta.treefile', checkIfExists: true),
                    file(projectDir + '/tests/test_data/Droso_ingroup.txt', checkIfExists: true)
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert path(process.out.out_tree[0][1]).exists() },
                { assert path(process.out.out_tree[0][1]).toString().endsWith('.treefile') },
                { assert process.out.out_tree[0][0] == [id:'FBgn0000055_NT_033779.5_10_species_12_seqs'] },
                { assert path(process.out.out_tree[0][1]).text.contains('(') }, // crude check for newick
                // Check that the output tree matches the expected tree
                { 
                    def tree = path(process.out.out_tree[0][1]).text
                    def regex = ~/\{Foreground\}:0\.014817/
                    def regex2 = ~/\{Foreground\}:0\.025516/
                    assert tree =~ regex
                    assert tree =~ regex2
                },
                // Check version file exists and has correct format
                { assert path(process.out.versions[0]).exists() },
                { assert path(process.out.versions[0]).text.contains('hyphy:') }
            )
        }

    }

    test("labeltree - treefile - stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [ id:'FBgn0000055_NT_033779.5_10_species_12_seqs'], 
                    file(projectDir + '/tests/test_data/FBgn0000055_NT_033779.5_10_species_12_seqs-unlabeled.fasta.treefile', checkIfExists: true),
                    file(projectDir + '/tests/test_data/Droso_ingroup.txt', checkIfExists: true)
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

}
